<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Example D3 Charts</title>
        <style>
            .parallel-coordinates path {
              fill: none;
            }
            text {
                fill: lightgrey;
            }
            body {
                font: 12px Arial;
            }

            path { 
                stroke: steelblue;
                stroke-width: 2;
                fill: none;
            }

            .axis line, .axis path {
                fill: none;
                stroke: #222;
                stroke-width: 1px;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: grey;
                stroke-width: 1;
                shape-rendering: crispEdges;
            }

            div.tooltip {	
                position: absolute;			
                text-align: center;			
                width: 60px;					
                height: 28px;					
                padding: 2px;				
                font: 12px sans-serif;		
                background: lightsteelblue;	
                border: 0px;		
                border-radius: 8px;			
                pointer-events: none;			
            }
        </style>
        <link rel="stylesheet" href="style.css"></link>
    </head>
    <body>
        <select onchange="chart(this.value)">
            <option value="Choose a visualization." selected disabled>Choose a chart.</option>
            <option value="bar">bar</option>
            <option value="scatterplot">scatterplot</option>
            <option value="parallel-coordinates">parallel-coordinates</option>
        </select>
        <div id="vis-container"></div>
        <script src="https://bl.ocks.org/syntagmatic/raw/3341641/render-queue.js"></script>
        <script src="./d3.v4.min.js"></script>
        <script>

            var width = 420;

            /* recreate deprecated d3 functionality lost b4 v4: d3.rebind */
            // Copies a variable number of methods from source to target.
            d3.rebind = function(target, source) {
                var i = 1, n = arguments.length, method;
                while (++i < n) target[method = arguments[i]] = d3_rebind(target, source, source[method]);
                return target;
            };

            // Method is assumed to be a standard D3 getter-setter:
            // If passed with no arguments, gets the value.
            // If passed with arguments, sets the value and returns the target.
            function d3_rebind(target, source, method) {
                return function() {
                    var value = method.apply(source, arguments);
                    return value === source ? target : value;
                };
            }

            /* patch d3v3 functionality into d4 */
            d3.functor = function(v) {
                return typeof v === "function" ? v : function() { return v; };
            };

            function chart(chartType) {
                d3.select('#vis-container').selectAll('*').remove();//remove scatterplot
                d3.select('#histogram').selectAll('*').remove();//remove histogram
                d3.select('#histogram').style('display', 'none');
                d3.select('.parallel-coordinates').remove();//remove parallel-coordinates

                // ############# bar ###############
                if (chartType === 'bar') {
                    var data = [1, 1, 2, 3, 5, 8, 13, 21, 13, 8, 5, 3, 2, 1, 1],
                        margin = {top: '10', left: '20', bottom: '20', right: '20'},
                        svg = d3.select('#vis-container')
                          .append('svg')
                          .attr('width', '500')
                          .attr('height', '200')
                          .style('border', '1px solid black'),
                        width = svg.attr('width'),
                        height = svg.attr('height'),
                        barWidth = svg.attr('width')/data.length,
                        barOffset = 1;
                        y = d3.scaleLinear().domain([0, d3.max(data)]).range([0, height]);
                    var barChart = svg.selectAll('rect')
                      .data(data).enter()
                        .append('rect')
                            .style('fill', 'lightblue')
                            .attr('width', barWidth - barOffset)
                            .attr('height', function(d){ return y(+d); })
                            .attr('x', function(d, i){ return i * +barWidth; })
                            .attr('y', function(d){ return +height - y(+d); });
                    var text = svg.selectAll('text')
                      .data(data).enter()
                        .append('text')
                            .attr('x', function(d, i){ return i * +barWidth + 10; })
                            .attr('y', function(d){ 
                                var unclamped = +height - y(+d) + 15;
                                if (unclamped <= 0){ return 15 }
                                if (unclamped >= +height){ return height - 15 }
                                return unclamped;
                             })
                            .text(function(d){ return String(d); })
                            .style('stroke', 'black');
                }

                // ############# histogram ###############
                if (chartType === 'histogram') {
                    /* create random distribution to plot */
                    //var randomData = d3.range(1000).map(d3.randomBates(10));

                    /* GIVE A LITERAL ARRAY OF DATA TO PLOT IN HISTOGRAM */
                    var data = [0, 1.87, 2.15, 1.22, 3.66, -0.72, 6.32, 11.12, 3.74, 20.75, 2.46, 7.53, 11.54, 18.17, -13.36, 10.19, 22.60, 27.19, -4.55, 40.77, 29.94, -3.23, 19.52, 17.01, 6.33, 27.79, 42.82, 44.23, -47.07, 2.75, 8.81, -4.55, -11.04, 27.79, -33.62, -18.18, 64.22, 12.34, 16.81, -10.67, 55.77, -51.92, 62.68, 60.21, 87.75, 98.30, 106.39, -7.37, 100.67, -8.24, 28.63, 31.33, 112.65, -16.13, 74.24, -32.83, -4.82, 79.82, 20.46, 26.43, 20.53, 18.80, -42.27, 9.16, -49.74, 1.81, 64.04, 16.02, 24.56, 50.33, 67.30, 152.71, 133.07, -18.12, 3.10, 122.51, 124.70, -38.26, -125.83, 37.52, 15.84, 205.88, -17.60, -68.71, -34.55, 71.09, -101.30, 204.20, 0.78, 119.08, 207.97, -19.59, 161.82, 9.74, 18.34, -102.75, -40.20, 204.92, 63.89, 155.60]

                    var formatCount = d3.format(",.0f");

                    var svg = d3.select("#vis-container").append("svg").attr('width', '960').attr("height", "700");
                        margin = {top: 10, right: 30, bottom: 30, left: 30},
                        width = +svg.attr("width") - margin.left - margin.right,
                        height = +svg.attr("height") - margin.top - margin.bottom,
                        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    var x = d3.scaleLinear()
                        .domain(d3.extent(data))
                        .rangeRound([0, width]);

                    var bins = d3.histogram()
                        .domain(x.domain())
                        .thresholds(x.ticks(data.length))
                        (data);

                    var y = d3.scaleLinear()
                        .domain([0, d3.max(bins, function(d) { return d.length; })])
                        .range([height, 0]);

                    var bar = g.selectAll(".bar")
                      .data(bins)
                      .enter().append("g")
                        .attr("class", "bar")
                        .attr("transform", function(d) { return "translate(" + x(d.x0) + "," + y(d.length) + ")"; });

                    var xAxis = d3.axisBottom()

                    d3.select('#histogram').style('display', 'block');

                    bar.append("rect")
                        .attr("x", 1)
                        .attr("width", x(bins[0].x1) - x(bins[0].x0) - 1)
                        .attr("height", function(d) { return height - y(d.length); });

                    bar.append("text")
                        .attr("dy", ".75em")
                        .attr("y", 6)
                        .attr("x", (x(bins[0].x1) - x(bins[0].x0)) / 2)
                        .attr("text-anchor", "middle")
                        .text(function(d) { return formatCount(d.length); });

                    g.append("g")
                        .attr("class", "axis axis--x")
                        .attr("transform", "translate(0," + height + ")")
                        .call(d3.axisBottom(x));
                }

                // ############## scatterplot ##################
                if (chartType === 'scatterplot') {
                    // generate random data
                    /*
                    const data = d3.range(50).map((d, i) => ({
                      x: Math.random(),
                      y: Math.random(),
                      id: i,
                      label: `Point ${i}`,
                    }));
                    */

                    /* ARRAY LITERAL FOR DATASET YIELDED BY FOLLOWING CODE:
                       d3.range(30).map(function(d){return {x: d, y: +d * (1 + 0.25 * (d3.randomNormal()()-.5))}})
                       FOLLOWED BY AN INTERACTIVE FIND-AND-REPLACE IN VIM:
                       %s/\([0-9]\{2}\)[0-9]\{2}[0-9]\+\>/\1/gc */
                    data = [
                      { x: 0, y: 0 },
                      { x: 1, y: 1.06 },
                      { x: 2, y: 2.21 },
                      { x: 3, y: 1.45 },
                      { x: 4, y: 3.79 },
                      { x: 5, y: 5.28 },
                      { x: 6, y: 7.84 },
                      { x: 7, y: 8.33 },
                      { x: 8, y: 10.02 },
                      { x: 9, y: 6.75 },
                      { x: 10, y: 8.53 },
                      { x: 11, y: 7.92 },
                      { x: 12, y: 11.69 },
                      { x: 13, y: 7.58 },
                      { x: 14, y: 4.59 },
                      { x: 15, y: 13.10 },
                      { x: 16, y: 8.20 },
                      { x: 17, y: 17.89 },
                      { x: 18, y: 18.24 },
                      { x: 19, y: 15.99 },
                      { x: 20, y: 14.22 },
                      { x: 21, y: 28.86 },
                      { x: 22, y: 9.90 },
                      { x: 23, y: 11.56 },
                      { x: 24, y: 13.32 },
                      { x: 25, y: 24.28 },
                      { x: 26, y: 8.04 },
                      { x: 27, y: 31.83 },
                      { x: 28, y: 29.69 },
                      { x: 29, y: 18.42 }
                    ];

                    // ----------------------------------------------------
                    // Build a basic scatterplot
                    // ----------------------------------------------------

                    // outer svg dimensions
                    const width = 600;
                    const height = 400;

                    // padding around the chart where axes will go
                    const padding = {
                      top: 20,
                      right: 20,
                      bottom: 40,
                      left: 50,
                    };

                    // inner chart dimensions, where the dots are plotted
                    const plotAreaWidth = width - padding.left - padding.right;
                    const plotAreaHeight = height - padding.top - padding.bottom;

                    // radius of points in the scatterplot
                    const pointRadius = 3;

                    // initialize scales
                    const xScale = d3.scaleLinear().domain(d3.extent(data, function(d){return d['x'];})).range([0, plotAreaWidth]);
                    const yScale = d3.scaleLinear().domain(d3.extent(data, function(d){return d['y'];})).range([plotAreaHeight, 0]);
                    const colorScale = d3.scaleLinear().domain([0, 1]).range(['#06a', '#0bb']);

                    // select the root container where the chart will be added
                    const container = d3.select('#vis-container');

                    // initialize main SVG
                    const svg = container.append('svg')
                      .attr('width', width)
                      .attr('height', height);

                    // the main <g> where all the chart content goes inside
                    const g = svg.append('g')
                      .attr('transform', `translate(${padding.left} ${padding.top})`);

                    // add in axis groups
                    const xAxisG = g.append('g').classed('x-axis', true)
                      .attr('transform', `translate(0 ${plotAreaHeight + pointRadius})`);

                    // x-axis label
                    g.append('text')
                      .attr('transform', `translate(${plotAreaWidth / 2} ${plotAreaHeight + (padding.bottom)})`)
                      .attr('dy', -4) // adjust distance from the bottom edge
                      .attr('class', 'axis-label')
                      .attr('text-anchor', 'middle')
                      .text('X Axis');

                    const yAxisG = g.append('g').classed('y-axis', true)
                      .attr('transform', `translate(${-pointRadius} 0)`);

                    // y-axis label
                    g.append('text')
                      .attr('transform', `rotate(270) translate(${-plotAreaHeight / 2} ${-padding.left})`)
                      .attr('dy', 12) // adjust distance from the left edge
                      .attr('class', 'axis-label')
                      .attr('text-anchor', 'middle')
                      .text('Y Axis');

                    // set up axis generating functions
                    const xTicks = Math.round(plotAreaWidth / 50);
                    const yTicks = Math.round(plotAreaHeight / 50);

                    const xAxis = d3.axisBottom(xScale)
                      .ticks(xTicks)
                      .tickSizeOuter(0);

                    const yAxis = d3.axisLeft(yScale)
                      .ticks(yTicks)
                      .tickSizeOuter(0);

                    // draw the axes
                    yAxisG.call(yAxis);
                    xAxisG.call(xAxis);

                    // Define the div for the tooltip
                    var div = d3.select("body").append("div")	
                        .attr("class", "tooltip")				
                        .style("opacity", 0);

                    // add in circles
                    const circles = g.append('g').attr('class', 'circles');
                    const binding = circles.selectAll('.data-point').data(data, d => d.id);
                    binding.enter().append('circle')
                        .classed('data-point', true)
                        .attr('r', pointRadius)
                        .attr('cx', d => xScale(d.x))
                        .attr('cy', d => yScale(d.y))
                        .attr('fill', d => colorScale(d.y))
                        .on("mouseover", function(d) {		
                            div.transition()		
                                .duration(100)		
                                .style("opacity", .9);		
                            div	.html(d.x + "<br/>"  + d.y)	
                                .style("left", (d3.event.pageX) + "px")		
                                .style("top", (d3.event.pageY - 28) + "px");	
                            })					
                        .on("mouseout", function(d) {		
                            div.transition()		
                                .duration(200)		
                                .style("opacity", 0);
                        });
                }

                // ############# parallel-coordinates ###############
                if (chartType === 'parallel-coordinates') {

                    /* DATASET FOR PLOTTING */
                    var data = 'name,economy (mpg),cylinders,displacement (cc),power (hp),weight (lb),0-60 mph (s),year\nAMC Ambassador Brougham,13,8,360,175,3821,11,73\nAMC Ambassador DPL,15,8,390,190,3850,8.5,70\nAMC Ambassador SST,17,8,304,150,3672,11.5,72';

                    var margin = {top: 30, right: 10, bottom: 10, left: 10},
                        width = 960 - margin.left - margin.right,
                        height = 500 - margin.top - margin.bottom;

                    var x = d3.scalePoint().range([0, width]).padding(1),
                        y = {};

                    var line = d3.line(),
                        axis = d3.axisLeft(),
                        background,
                        foreground;

                    var svg = d3.select("body").append("svg")
                        .attr("class", "parallel-coordinates")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    var cars = d3.csvParse(data);

                    (function(cars) {

                      // Extract the list of dimensions and create a scale for each.
                      x.domain(dimensions = d3.keys(cars[0]).filter(function(d) {
                        return d != "name" && (y[d] = d3.scaleLinear()
                            .domain(d3.extent(cars, function(p) { return +p[d]; }))
                            .range([height, 0]));
                      }));

                      // Add grey background lines for context.
                      background = svg.append("g")
                          .attr("class", "background")
                        .selectAll("path")
                          .data(cars)
                        .enter().append("path")
                          .attr("d", path);

                      // Add blue foreground lines for focus.
                      foreground = svg.append("g")
                          .attr("class", "foreground")
                        .selectAll("path")
                          .data(cars)
                        .enter().append("path")
                          .attr("d", path);

                      // Add a group element for each dimension.
                      var g = svg.selectAll(".dimension")
                          .data(dimensions)
                        .enter().append("g")
                          .attr("class", "dimension")
                          .attr("transform", function(d) { return "translate(" + x(d) + ")"; });

                      // Add an axis and title.
                      g.append("g")
                          .attr("class", "axis")
                          .each(function(d) { d3.select(this).call(axis.scale(y[d])); })
                        .append("text")
                          .style("text-anchor", "middle")
                          .attr("y", -9)
                          .text(function(d) { return d; });

                      // Add and store a brush for each axis.
                      /*
                      g.append("g")
                          .attr("class", "brush")
                          .each(function(d) {console.log({foo:[[0, -y[d].range()[0]], [20, y[d].range()[1]]]}); d3.select(this).call(y[d].brush = d3.brushY().extent([[0, -y[d].range()[0]], [20, y[d].range()[1]]]).on("brush", brush)); })//y(y[d]).on("brush", brush)); })
                        .selectAll("rect")
                          .attr("x", -8)
                          .attr("width", 16);
                    */
                    })(cars);// pass cars as the closure's parameter


                    // Returns the path for a given data point.
                    function path(d) {
                      console.log('path called with d =',d,'\n returning',dimensions.map(function(p) { return [x(p), y[p](d[p])]; }));
                      return line(dimensions.map(function(p) { return [x(p), y[p](d[p])]; }));
                    }
                }
            }
        </script>
    </body>
</html>
